<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="MobileOptimized" content="176"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="robots" content="noindex,nofollow"/>

    <title>PUB - SP</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/fontawesome.min.css"
          integrity="sha512-UuQ/zJlbMVAw/UU8vVBhnI4op+/tFOpQZVT+FormmIEhRSCnJWyHiBbEVgM4Uztsht41f3FzVWgLuwzUqOObKw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/solid.min.css"
          integrity="sha512-Hp+WwK4QdKZk9/W0ViDvLunYjFrGJmNDt6sCflZNkjgvNq9mY+0tMbd6tWMiAlcf1OQyqL4gn2rYp7UsfssZPA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <link href="https://unpkg.com/gijgo@1.9.14/css/gijgo.min.css" rel="stylesheet" type="text/css"/>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/css/tempus-dominus.min.css"
          crossorigin="anonymous">

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        function setThemeClass() {
            document.documentElement.className = Telegram.WebApp.colorScheme;
        }

        Telegram.WebApp.onEvent('themeChanged', setThemeClass);
        setThemeClass();
    </script>
    <style>
        .list-group-item:first-child {
            border-top-left-radius: 0 !important;
            border-top-right-radius: 0 !important;
        }

        .gj-grid-md {
            border-color: #e6edf3 !important;
        }

        .gj-grid-md td {
            border-top-color: #e6edf3 !important;
            border-bottom-color: #e6edf3 !important;
        }

        #header {
            background-color: var(--placeholder-color);
        }
    </style>

    <link href="assets/css/index.css" rel="stylesheet">
    <link href="assets/css/material-box.css" rel="stylesheet">
    <link href="assets/css/tempus-dominus-v6.0.css" rel="stylesheet">

</head>
<body>

<div style="padding-bottom: 76px;">
    <div id="header"
         style="height: 160px; text-align: center; color: white; font-size: 2rem; align-items: center; display: grid;">
        Welcome From PUB Share - SG
    </div>
    <div class="p-3 pt-0">
        <div class="material-input-group-read-only mt-5" id="pub_date" data-td-target-input="nearest"
             data-td-target-toggle="nearest">
            <label>Select Date</label>
            <input class="d-none" type="text" placeholder="MMMM YYYY" data-td-target="#pub_date">
            <input disabled type="text" placeholder="MMMM YYYY" id="pub_date_input">
            <i class="fa-solid fa-calendar"></i>
            <div style="position: absolute; top: 4px; width: 100%; height: 24px; cursor: pointer;"
                 data-td-target="#pub_date" data-td-toggle="datetimepicker"></div>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
            <input class="mdl-textfield__input" type="text" id="postalCode">
            <label class="mdl-textfield__label" for="postalCode">
                Postal Code
            </label>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
            <input class="mdl-textfield__input" type="text" id="unitNumber">
            <label class="mdl-textfield__label" for="unitNumber">
                Unit Number
            </label>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
            <input class="mdl-textfield__input" type="number" pattern="-?[0-9]*(\.[0-9]+)?" id="pubFee">
            <label class="mdl-textfield__label" for="pubFee">
                PUB Total Amount
            </label>
            <span class="mdl-textfield__error">Input is not a number!</span>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
            <input class="mdl-textfield__input" type="number" pattern="-?[0-9]*(\.[0-9]+)?" id="internetFee">
            <label class="mdl-textfield__label" for="internetFee">
                Internet Total Amount
            </label>
            <span class="mdl-textfield__error">Input is not a number!</span>
        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="pt-3 pb-3"
                     style="text-align: center; background-color: #e6edf3; color: #889caa; font-size: 24px; align-items: center; display: grid; border-radius: 4px 4px 0 0; border-color: #e6edf3; font-weight: 700; font-family: Georgia,serif;">
                    Long-Term
                </div>
                <table id="longTermTable"></table>
                <button type="button" class="btn btn-primary w-100 mt-2 mb-2" data-bs-toggle="modal"
                        data-bs-target="#longTermDialog" id="btnAddLongTerm" disabled>
                    Add New Long-Term
                </button>
            </div>

            <div class="col-md-6">
                <div class="pt-3 pb-3"
                     style="text-align: center; background-color: #e6edf3; color: #889caa; font-size: 24px; align-items: center; display: grid; border-radius: 4px 4px 0 0; border-color: #e6edf3; font-weight: 700; font-family: Georgia,serif;">
                    Short-Term
                </div>
                <div id="shortTermList">
                    <table id="shortTermTable"></table>
                    <button type="button" class="btn btn-primary w-100 mt-2 mb-2" data-bs-toggle="modal"
                            data-bs-target="#shortTermDialog" id="btnAddShortTerm" disabled>
                        Add New Long-Term
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="longTermDialog" tabindex="-1" aria-labelledby="longTermDialogTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="longTermDialogTitle">Add Long-Term</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
                    <input class="mdl-textfield__input" type="text" id="edtLongTermName">
                    <label class="mdl-textfield__label" for="edtLongTermName">
                        Enter Name
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSaveLongTerm" disabled>Add</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shortTermDialog" tabindex="-1" aria-labelledby="shortTermDialogTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="shortTermDialogTitle">Add Short-Term</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
                    <input class="mdl-textfield__input" type="text" id="edtShortTermName"
                           style="color: black!important;">
                    <label class="mdl-textfield__label" for="edtShortTermName">
                        Enter Name
                    </label>
                </div>
                <div class="material-input-group-read-only" style="margin-top: 20px;" id="start_date"
                     data-td-target-input="nearest" data-td-target-toggle="nearest">
                    <label>Start Date</label>
                    <input class="d-none" type="text" placeholder="MMMM YYYY" data-td-target="#start_date">
                    <input disabled type="text" placeholder="MMMM YYYY" id="start_date_input">
                    <i class="fa-solid fa-calendar"></i>
                    <div style="position: absolute; top: 4px; width: 100%; height: 24px; cursor: pointer;"
                         data-td-target="#start_date" data-td-toggle="datetimepicker"></div>
                </div>
                <div class="material-input-group-read-only mt-5" id="end_date" data-td-target-input="nearest"
                     data-td-target-toggle="nearest">
                    <label>End Date</label>
                    <input class="d-none" type="text" placeholder="MMMM YYYY" data-td-target="#end_date">
                    <input disabled type="text" placeholder="MMMM YYYY" id="end_date_input">
                    <i class="fa-solid fa-calendar"></i>
                    <div style="position: absolute; top: 4px; width: 100%; height: 24px; cursor: pointer;"
                         data-td-target="#end_date" data-td-toggle="datetimepicker"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSaveShortTerm" disabled>Add</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>

<script src="https://unpkg.com/gijgo@1.9.14/js/gijgo.min.js" type="text/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/js/tempus-dominus.min.js"
        crossorigin="anonymous"></script>

<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

<script src="assets/js/api.js"></script>
<script src="assets/js/app.js"></script>
<script src="assets/js/utils.js"></script>
<script src="assets/js/apiService.js"></script>

<script>
    $(document).ready(function () {
        let minDateForStart;
        let maxDateForStart;
        let minDateForEnd;
        let maxDateForEnd;
        let pubDate = null
        let postalCode = null
        let unitNumber = null
        let pubTotalAmount = null
        let internetAmount = null
        let pubDateInput = $(`#pub_date_input`)
        let btnAddLongTerm = $(`#btnAddLongTerm`)
        let btnShortTerm = $(`#btnAddShortTerm`)
        let startDate = $(`#start_date`)
        let endDate = $(`#end_date`)
        let startDateInput = $(`#start_date_input`)
        let endDateInput = $(`#end_date_input`)
        let edtLongTermName = $(`#edtLongTermName`)
        let edtShortTermName = $(`#edtShortTermName`)
        let btnSaveLongTerm = $(`#btnSaveLongTerm`)
        let btnSaveShortTerm = $(`#btnSaveShortTerm`)

        let App = $.App(false)
        let ApiService = $.ApiService(App)

        let longTermDialog = new bootstrap.Modal(`#longTermDialog`)
        document.getElementById(`longTermDialog`).addEventListener(`show.bs.modal`, _ => {
            edtLongTermName.val(``)
            btnSaveShortTerm.attr(`disabled`, true)
        })

        let shortTermDialog = new bootstrap.Modal(`#shortTermDialog`)
        document.getElementById(`shortTermDialog`).addEventListener(`show.bs.modal`, _ => {
            edtShortTermName.val(``)
            startDatePicker.dates.clear()
            endDatePicker.dates.clear()
            btnSaveShortTerm.attr(`disabled`, true)
        })

        const pubDatePicker = new tempusDominus.TempusDominus(
            document.getElementById("pub_date"),
            {
                display: {
                    icons: {
                        previous: `fa-solid fa-chevron-left`,
                        next: `fa-solid fa-chevron-right`,
                        close: `fa-solid fa-xmark`,
                        clear: `fa-solid fa-trash`
                    },
                    viewMode: 'months',
                    components: {
                        calendar: true,
                        date: false,
                        month: true,
                        year: true,
                        decades: true,
                        clock: false
                    },
                    theme: 'auto',
                    toolbarPlacement: 'bottom',
                    keepOpen: false,
                    buttons: {
                        today: false,
                        clear: true,
                        close: true
                    }
                },
                useCurrent: false,
                localization: {
                    format: 'MMM yyyy',
                }
            }
        )
        const startDatePicker = new tempusDominus.TempusDominus(
            document.getElementById("start_date"),
            {
                display: {
                    icons: {
                        previous: `fa-solid fa-chevron-left`,
                        next: `fa-solid fa-chevron-right`,
                        close: `fa-solid fa-xmark`,
                        clear: `fa-solid fa-trash`,
                        today: `fa-solid fa-calendar-day`
                    },
                    viewMode: 'calendar',
                    components: {
                        calendar: true,
                        date: true,
                        month: true,
                        year: true,
                        decades: false,
                        clock: false
                    },
                    theme: 'auto',
                    toolbarPlacement: 'bottom',
                    keepOpen: false,
                    buttons: {
                        today: true,
                        clear: true,
                        close: true
                    }
                },
                localization: {
                    format: 'dd MMMM yyyy',
                },
                useCurrent: false
            }
        )
        const endDatePicker = new tempusDominus.TempusDominus(
            document.getElementById("end_date"),
            {
                display: {
                    icons: {
                        previous: `fa-solid fa-chevron-left`,
                        next: `fa-solid fa-chevron-right`,
                        close: `fa-solid fa-xmark`,
                        clear: `fa-solid fa-trash`,
                        today: `fa-solid fa-calendar-day`
                    },
                    viewMode: 'calendar',
                    components: {
                        calendar: true,
                        date: true,
                        month: true,
                        year: true,
                        decades: false,
                        clock: false
                    },
                    theme: 'auto',
                    toolbarPlacement: 'bottom',
                    keepOpen: false,
                    buttons: {
                        today: true,
                        clear: true,
                        close: true
                    }
                },
                localization: {
                    format: 'dd MMMM yyyy',
                },
                useCurrent: false
            }
        )

        const longTermList = $('#longTermTable').grid({
            dataSource: [],
            notFoundText: 'Please add new Long-Term person.',
            primaryKey: 'no',
            orderNumberField: 'no',
            columns: [
                {
                    field: 'no',
                    title: 'No.',
                    width: 62
                },
                {
                    field: 'name',
                    title: 'Name',
                    editor: true
                },
                {
                    field: '',
                    width: 56,
                    type: 'icon',
                    icon: 'fa-solid fa-trash',
                    events: {
                        'click': function (e) {
                            longTermList.removeRow(e.data.id)
                            longTermList.getAll(true).forEach((data, index) => {

                                longTermList.updateRow(
                                    data.no,
                                    {
                                        no: index + 1,
                                        name: data.name
                                    }
                                )

                            })
                        }
                    }
                }
            ]
        });

        const shortTermList = $('#shortTermTable').grid({
            dataSource: [],
            notFoundText: 'Please add new Short-Term person.',
            primaryKey: 'no',
            orderNumberField: 'no',
            columns: [
                {
                    field: 'no',
                    title: 'No.',
                    width: 62
                },
                {
                    field: 'name',
                    title: 'Name',
                    editor: true
                },
                {
                    field: 'date',
                    title: 'Date',
                    width: 110,
                    align: 'center'
                },
                {
                    field: '',
                    width: 56,
                    type: 'icon',
                    icon: 'fa-solid fa-trash',
                    events: {
                        'click': function (e) {
                            shortTermList.removeRow(e.data.id)
                            shortTermList.getAll(true).forEach((data, index) => {

                                shortTermList.updateRow(
                                    data.no,
                                    {
                                        no: index + 1,
                                        name: data.name,
                                        date: data.date
                                    }
                                )

                            })
                        }
                    }
                }
            ]
        });

        pubDatePicker.subscribe(tempusDominus.Namespace.events.change, (e) => {
            pubDate = e.date
            if (e.date !== e.olddate) {
                shortTermList.clear(true)
            }

            pubDateInput.val(``)
            if (e.date != null) {
                console.log(e.date.toLocaleString('default', {
                    month: 'long',
                    year: 'numeric'
                }))
                pubDateInput.val(
                    e.date.toLocaleString('default', {
                        month: 'long',
                        year: 'numeric'
                    })
                )
            }

            if (e.date == null) {
                btnAddLongTerm.attr(`disabled`, true)
                btnShortTerm.attr(`disabled`, true)

                checkInput()
                return
            }
            btnAddLongTerm.removeAttr(`disabled`)
            btnShortTerm.removeAttr(`disabled`)
            minDateForStart = new Date(
                e.date.getFullYear(),
                e.date.getMonth(),
                1
            )
            maxDateForStart = new Date(
                e.date.getFullYear(),
                e.date.getMonth() + 1,
                0,
                23,
                59,
                59,
                59
            )

            minDateForEnd = minDateForStart
            maxDateForEnd = maxDateForStart

            if (startDate.val() !== `` && endDate.val() !== undefined) {
                maxDateForStart = endDatePicker.viewDate
            }

            if (startDate.val() !== `` && endDate.val() !== undefined) {
                minDateForEnd = startDatePicker.viewDate
            }

            startDatePicker.updateOptions({
                restrictions: {
                    minDate: minDateForStart,
                    maxDate: maxDateForStart
                }
            })

            endDatePicker.updateOptions({
                restrictions: {
                    minDate: minDateForEnd,
                    maxDate: maxDateForEnd
                }
            })

            startDatePicker.dates.clear()
            endDatePicker.dates.clear()

            checkInput()
        })

        startDatePicker.subscribe(tempusDominus.Namespace.events.change, (e) => {

            startDateInput.val(``)
            if (e.date != null) {
                startDateInput.val(
                    e.date.toLocaleString('default', {
                        day: `2-digit`,
                        month: 'short',
                        year: 'numeric'
                    })
                )
            }

            if (e.date !== undefined) {
                endDatePicker.updateOptions({
                    restrictions: {
                        minDate: e.date
                    }
                })
            } else {
                endDatePicker.updateOptions({
                    restrictions: {
                        minDate: minDateForEnd
                    }
                })
            }
            if (edtShortTermName.val().length === 0 || e.date == null || endDatePicker.viewDate == null) {
                btnSaveShortTerm.attr(`disabled`, true)
            } else {
                btnSaveShortTerm.removeAttr(`disabled`)
            }
            checkInput()
        })

        endDatePicker.subscribe(tempusDominus.Namespace.events.change, (e) => {

            endDateInput.val(``)
            if (e.date != null) {
                endDateInput.val(
                    e.date.toLocaleString('default', {
                        day: `2-digit`,
                        month: 'short',
                        year: 'numeric'
                    })
                )
            }

            if (e.date !== undefined) {
                startDatePicker.updateOptions({
                    restrictions: {
                        maxDate: e.date
                    }
                })
            } else {
                startDatePicker.updateOptions({
                    restrictions: {
                        maxDate: maxDateForStart
                    }
                })
            }
            if (edtShortTermName.val().length === 0 || e.date == null || startDatePicker.viewDate == null) {
                btnSaveShortTerm.attr(`disabled`, true)
            } else {
                btnSaveShortTerm.removeAttr(`disabled`)
            }
            checkInput()
        })

        edtLongTermName.on(`input`, function (e) {
            if ($(this).val().length === 0) {
                btnSaveLongTerm.attr(`disabled`, true)
            } else {
                btnSaveLongTerm.removeAttr(`disabled`)
            }
            checkInput()
        })
        edtShortTermName.on(`input`, function (e) {
            if ($(this).val().length === 0 || startDatePicker.viewDate == null || endDatePicker.viewDate == null) {
                btnSaveShortTerm.attr(`disabled`, true)
            } else {
                btnSaveShortTerm.removeAttr(`disabled`)
            }
            checkInput()
        })
        $(`#postalCode`).on(`input`, function () {
            postalCode = $(`#postalCode`).val()
            checkInput()
        })
        $(`#unitNumber`).on(`input`, function () {
            unitNumber = $(`#unitNumber`).val()
            checkInput()
        })
        $(`#pubFee`).on(`input`, function () {
            try {
                pubTotalAmount = parseInt($(`#pubFee`).val())
            } catch (e) {
                pubTotalAmount = null
            }
            checkInput()
        })
        $(`#internetFee`).on(`input`, function () {
            try {
                internetAmount = parseInt($(`#internetFee`).val())
            } catch (e) {
                internetAmount = null
            }
            checkInput()
        })

        btnSaveLongTerm.on(`click`, function () {
            if (edtLongTermName.val().length === 0) return
            longTermList.addRow(
                {
                    'no': longTermList.getAll(true).length + 1,
                    'name': edtLongTermName.val()
                }
            )
            longTermDialog.hide()
        })
        btnSaveShortTerm.on(`click`, function () {
            shortTermList.addRow(
                {
                    'no': shortTermList.getAll(true).length + 1,
                    'name': edtShortTermName.val(),
                    'date': startDatePicker.viewDate.toLocaleString('default', {
                        day: `2-digit`,
                        month: '2-digit',
                        year: 'numeric'
                    }).replaceAll(`/`, `-`) + '\n' + endDatePicker.viewDate.toLocaleString('default', {
                        day: `2-digit`,
                        month: '2-digit',
                        year: 'numeric'
                    }).replaceAll(`/`, `-`)
                }
            )
            shortTermDialog.hide()
        })

        App.MainButton.text = "Submit"
        App.MainButton.onClick(() => {
            if (pubTotalAmount <= 0) {
                App.showPopup(
                    "Error",
                    "PUB Amount can't not be less than equal 0.",
                    [
                        {
                            id: 'okay',
                            type: 'default',
                            text: 'Okay'
                        }
                    ]
                )
                return
            }
            if (longTermList.getAll(true).length <= 1) {
                App.showPopup(
                    "Error",
                    "Long-Term user count should not be less than equal 1.",
                    [
                        {
                            id: 'okay',
                            type: 'default',
                            text: 'Okay'
                        }
                    ]
                )
                return
            }
            let data = {
                pub_date: pubDate,
                pub_amount: pubTotalAmount,
                internet_amount: internetAmount,
                postal_code: postalCode,
                unit_number: unitNumber,
                long_term_list: longTermList.getAll(true),
                short_term_list: shortTermList.getAll(true)
            }
            if (shortTermList.getAll(true).length === 0) {
                App.showPopup(
                    "Warning",
                    "Are you sure to Submit without adding Short-Term?",
                    [
                        {
                            id: 'okay',
                            type: 'destructive',
                            text: 'Okay'
                        },
                        {
                            id: 'cancel',
                            type: 'default',
                            text: 'Cancel'
                        }
                    ],
                    function (button_id) {
                        if (button_id === "okay") {
                            if (App.userId != null) {
                                ApiService.submitData(
                                    {
                                        "user_id": App.userId,
                                        "data": data
                                    },
                                    function (response) {
                                        console.log(response)
                                        App.close()
                                    }
                                )
                            }
                        }
                    }
                )
            } else if (App.userId != null) {
                ApiService.submitData(
                    {
                        "user_id": App.userId,
                        "data": data
                    },
                    function (response) {
                        console.log(response)
                    }
                )
            }
        })

        App.BackButton.onClick(() => {
        })

        function checkInput() {
            if (pubDate != null && postalCode !== `` && postalCode != null && unitNumber !== `` && unitNumber != null && pubTotalAmount != null && !isNaN(pubTotalAmount) && internetAmount != null && !isNaN(internetAmount)) {
                App.enableClosingConfirmation()
                App.MainButton.show()
            } else {
                App.disableClosingConfirmation()
                App.MainButton.hide()
            }
        }
    })
</script>

</body>
</html>
