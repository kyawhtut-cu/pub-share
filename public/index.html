<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="MobileOptimized" content="176"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="robots" content="noindex,nofollow"/>

    <title>PUB - SP</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/fontawesome.min.css"
          integrity="sha512-UuQ/zJlbMVAw/UU8vVBhnI4op+/tFOpQZVT+FormmIEhRSCnJWyHiBbEVgM4Uztsht41f3FzVWgLuwzUqOObKw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/solid.min.css"
          integrity="sha512-Hp+WwK4QdKZk9/W0ViDvLunYjFrGJmNDt6sCflZNkjgvNq9mY+0tMbd6tWMiAlcf1OQyqL4gn2rYp7UsfssZPA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <link href="https://unpkg.com/gijgo@1.9.14/css/gijgo.min.css" rel="stylesheet" type="text/css"/>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/css/tempus-dominus.min.css"
          crossorigin="anonymous">

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        function setThemeClass() {
            document.documentElement.className = Telegram.WebApp.colorScheme
        }

        Telegram.WebApp.onEvent('themeChanged', setThemeClass)
        setThemeClass()
    </script>
    <style>
        .list-group-item:first-child {
            border-top-left-radius: 0 !important;
            border-top-right-radius: 0 !important;
        }

        .gj-grid-md {
            border-color: #e6edf3 !important;
        }

        .gj-grid-md td {
            border-top-color: #e6edf3 !important;
            border-bottom-color: #e6edf3 !important;
        }

        #header {
            background-color: var(--placeholder-color);
        }
    </style>

    <link href="assets/css/index.css" rel="stylesheet">
    <link href="assets/css/material-box.css" rel="stylesheet">
    <link href="assets/css/tempus-dominus-v6.0.css" rel="stylesheet">

</head>
<body>

<div style="padding-bottom: 76px;">
    <div id="header"
         style="height: 160px; text-align: center; color: white; font-size: 2rem; align-items: center; display: grid;">
        Welcome From PUB Share - SG
    </div>
    <div class="p-3">
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100" id="divGenerateTemplateTitle">
            <input class="mdl-textfield__input" type="text" id="pubGenerateTemplateTitle">
            <label class="mdl-textfield__label" for="pubGenerateTemplateTitle">
                Generate Template Title
            </label>
        </div>
        <div class="row">
            <div class="col-md-6 material-input-group-read-only" style="margin-top: 20px;" id="pub_start_date"
                 data-td-target-input="nearest" data-td-target-toggle="nearest">
                <input type="text" id="pubStartDateInput" placeholder="MMMM YYYY" data-tg-target="#pub_start_date"
                       readonly
                       onfocus="this.blur()">
                <label for="pubStartDateInput">PUB Start Date</label>
                <i class="fa-solid fa-calendar"></i>
                <div style="position: absolute; top: 4px; width: 100%; height: 24px; cursor: pointer;"
                     data-td-target="#end_date" data-td-toggle="datetimepicker"></div>
            </div>
            <div class="col-md-6 material-input-group-read-only" style="margin-top: 20px;" id="pub_end_date"
                 data-td-target-input="nearest" data-td-target-toggle="nearest">
                <input type="text" id="pubEndDateInput" placeholder="MMMM YYYY" data-td-target="#pub_end_date" readonly
                       onfocus="this.blur()">
                <label for="pubEndDateInput">PUB End Date</label>
                <i class="fa-solid fa-calendar"></i>
                <div style="position: absolute; top: 4px; width: 100%; height: 24px; cursor: pointer;"
                     data-td-target="#end_date" data-td-toggle="datetimepicker"></div>
            </div>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100" id="divPostalCode">
            <input class="mdl-textfield__input" type="text" id="postalCode">
            <label class="mdl-textfield__label" for="postalCode">
                Postal Code
            </label>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100" id="divUnitNumber">
            <input class="mdl-textfield__input" type="text" id="unitNumber">
            <label class="mdl-textfield__label" for="unitNumber">
                Unit Number
            </label>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
            <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?" id="pubFee">
            <label class="mdl-textfield__label" for="pubFee">
                PUB Total Amount
            </label>
            <span class="mdl-textfield__error">Input is not a number!</span>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
            <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?" id="internetFee">
            <label class="mdl-textfield__label" for="internetFee">
                Internet Total Amount
            </label>
            <span class="mdl-textfield__error">Input is not a number!</span>
        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="pt-4 pb-4"
                     style="text-align: center; background-color: #e6edf3; color: #889caa; font-size: 24px; align-items: center; display: grid; border-radius: 4px 4px 0 0; border-color: #e6edf3; font-weight: 700; font-family: Georgia,serif;">
                    Long-Term
                </div>
                <table id="longTermTable"></table>
                <button type="button" class="btn btn-primary w-100 mt-2 mb-3" data-bs-toggle="modal"
                        data-bs-target="#longTermDialog" id="btnAddLongTerm">
                    Add New Long-Term
                </button>
            </div>

            <div class="col-md-6">
                <div class="pt-4 pb-4"
                     style="text-align: center; background-color: #e6edf3; color: #889caa; font-size: 24px; align-items: center; display: grid; border-radius: 4px 4px 0 0; border-color: #e6edf3; font-weight: 700; font-family: Georgia,serif;">
                    Short-Term
                </div>
                <div id="shortTermList">
                    <table id="shortTermTable"></table>
                    <button type="button" class="btn btn-primary w-100 mt-2 mb-3" data-bs-toggle="modal"
                            data-bs-target="#shortTermDialog" id="btnAddShortTerm" disabled>
                        Add New Short-Term
                    </button>
                </div>
            </div>
        </div>
        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="saveForNextTime"
               id="labelSaveForNextTime">
            <input type="checkbox" id="saveForNextTime" class="mdl-checkbox__input">
            <span class="mdl-checkbox__label">Save information for next time.</span>
        </label>
    </div>
</div>

<div class="modal fade" id="longTermDialog" tabindex="-1" aria-labelledby="longTermDialogTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="longTermDialogTitle">Add Long-Term</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
                    <input class="mdl-textfield__input" type="text" id="edtLongTermName">
                    <label class="mdl-textfield__label" for="edtLongTermName">
                        Enter Name
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSaveLongTerm" disabled>Add</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shortTermDialog" tabindex="-1" aria-labelledby="shortTermDialogTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="shortTermDialogTitle">Add Short-Term</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label w-100">
                    <input class="mdl-textfield__input" type="text" id="edtShortTermName"
                           style="color: black!important;">
                    <label class="mdl-textfield__label" for="edtShortTermName">
                        Enter Name
                    </label>
                </div>
                <div class="material-input-group-read-only" style="margin-top: 20px;" id="start_date"
                     data-td-target-input="nearest" data-td-target-toggle="nearest">
                    <label for="startDateInput">Start Date</label>
                    <input type="text" id="startDateInput" placeholder="MMMM YYYY" data-tg-target="#start_date" readonly
                           onfocus="this.blur()">
                    <i class="fa-solid fa-calendar"></i>
                    <div style="position: absolute; top: 4px; width: 100%; height: 24px; cursor: pointer;"
                         data-td-target="#start_date" data-td-toggle="datetimepicker"></div>
                </div>
                <div class="material-input-group-read-only mt-5" id="end_date" data-td-target-input="nearest"
                     data-td-target-toggle="nearest">
                    <label for="endDateInput">End Date</label>
                    <input type="text" id="endDateInput" placeholder="MMMM YYYY" data-tg-target="#end_date" readonly onfocus="this.blur()">
                    <i class="fa-solid fa-calendar"></i>
                    <div style="position: absolute; top: 4px; width: 100%; height: 24px; cursor: pointer;"
                         data-td-target="#end_date" data-td-toggle="datetimepicker"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSaveShortTerm" disabled>Add</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>

<script src="https://unpkg.com/gijgo@1.9.14/js/gijgo.min.js" type="text/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/js/tempus-dominus.min.js"
        crossorigin="anonymous"></script>

<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

<script src="assets/js/api.js"></script>
<script src="assets/js/app.js"></script>
<script src="assets/js/utils.js"></script>
<script src="assets/js/apiService.js"></script>

<script>
    $(document).ready(function () {
        let minDateForStart
        let maxDateForStart
        let minDateForEnd
        let maxDateForEnd
        let pubStartDate = null
        let pubEndDate = null
        let postalCode = null
        let unitNumber = null
        let pubTotalAmount = null
        let internetAmount = null
        let pubGenerateTemplateTitle = null
        let pubGenerateTemplateTitleInput = $(`#pubGenerateTemplateTitle`)
        let postalCodeInput = $(`#postalCode`)
        let unitNumberInput = $(`#unitNumber`)
        let btnShortTerm = $(`#btnAddShortTerm`)
        let edtLongTermName = $(`#edtLongTermName`)
        let edtShortTermName = $(`#edtShortTermName`)
        let btnSaveLongTerm = $(`#btnSaveLongTerm`)
        let btnSaveShortTerm = $(`#btnSaveShortTerm`)
        let pubFeeInput = $(`#pubFee`)
        let internetFeeInput = $(`#internetFee`)
        let longTermList = []
        let shortTermList = []

        let App = $.App(false)
        let ApiService = $.ApiService(App)

        let longTermDialog = new bootstrap.Modal(`#longTermDialog`)
        document.getElementById(`longTermDialog`).addEventListener(`show.bs.modal`, _ => {
            edtLongTermName.val(``)
            btnSaveShortTerm.attr(`disabled`, true)
        })

        let shortTermDialog = new bootstrap.Modal(`#shortTermDialog`)
        document.getElementById(`shortTermDialog`).addEventListener(`show.bs.modal`, _ => {
            edtShortTermName.val(``)
            startDatePicker.dates.clear()
            endDatePicker.dates.clear()
            btnSaveShortTerm.attr(`disabled`, true)
        })

        const pubStartDatePicker = new tempusDominus.TempusDominus(
            document.getElementById(`pub_start_date`),
            {
                display: {
                    icons: {
                        previous: `fa-solid fa-chevron-left`,
                        next: `fa-solid fa-chevron-right`,
                        close: `fa-solid fa-xmark`,
                        clear: `fa-solid fa-trash`,
                        today: `fa-solid fa-calendar-day`
                    },
                    viewMode: 'calendar',
                    components: {
                        calendar: true,
                        date: true,
                        month: true,
                        year: true,
                        decades: false,
                        clock: false
                    },
                    theme: 'auto',
                    toolbarPlacement: 'bottom',
                    keepOpen: false
                },
                localization: {
                    format: 'dd MMMM yyyy',
                },
                useCurrent: false,
                restrictions: {
                    maxDate: new Date()
                }
            }
        )
        const pubEndDatePicker = new tempusDominus.TempusDominus(
            document.getElementById(`pub_end_date`),
            {
                display: {
                    icons: {
                        previous: `fa-solid fa-chevron-left`,
                        next: `fa-solid fa-chevron-right`,
                        close: `fa-solid fa-xmark`,
                        clear: `fa-solid fa-trash`,
                        today: `fa-solid fa-calendar-day`
                    },
                    viewMode: 'calendar',
                    components: {
                        calendar: true,
                        date: true,
                        month: true,
                        year: true,
                        decades: false,
                        clock: false
                    },
                    theme: 'auto',
                    toolbarPlacement: 'bottom',
                    keepOpen: false
                },
                localization: {
                    format: 'dd MMMM yyyy',
                },
                useCurrent: false,
                restrictions: {
                    maxDate: new Date()
                }
            }
        )
        const startDatePicker = new tempusDominus.TempusDominus(
            document.getElementById(`start_date`),
            {
                display: {
                    icons: {
                        previous: `fa-solid fa-chevron-left`,
                        next: `fa-solid fa-chevron-right`,
                        close: `fa-solid fa-xmark`,
                        clear: `fa-solid fa-trash`,
                        today: `fa-solid fa-calendar-day`
                    },
                    viewMode: 'calendar',
                    components: {
                        calendar: true,
                        date: true,
                        month: true,
                        year: true,
                        decades: false,
                        clock: false
                    },
                    theme: 'auto',
                    toolbarPlacement: 'bottom',
                    keepOpen: false,
                },
                localization: {
                    format: 'dd MMMM yyyy',
                },
                useCurrent: false
            }
        )
        const endDatePicker = new tempusDominus.TempusDominus(
            document.getElementById(`end_date`),
            {
                display: {
                    icons: {
                        previous: `fa-solid fa-chevron-left`,
                        next: `fa-solid fa-chevron-right`,
                        close: `fa-solid fa-xmark`,
                        clear: `fa-solid fa-trash`,
                        today: `fa-solid fa-calendar-day`
                    },
                    viewMode: 'calendar',
                    components: {
                        calendar: true,
                        date: true,
                        month: true,
                        year: true,
                        decades: false,
                        clock: false
                    },
                    theme: 'auto',
                    toolbarPlacement: 'bottom',
                    keepOpen: false
                },
                localization: {
                    format: 'dd MMMM yyyy',
                },
                useCurrent: false
            }
        )

        const longTermTable = $(`#longTermTable`).grid({
            dataSource: [],
            notFoundText: 'Please add new Long-Term person.',
            primaryKey: 'no',
            orderNumberField: 'no',
            columns: [
                {
                    field: 'no',
                    title: 'No.',
                    width: 62
                },
                {
                    field: 'name',
                    title: 'Name',
                    editor: false
                },
                {
                    field: '',
                    width: 56,
                    type: 'icon',
                    icon: 'fa-solid fa-trash',
                    events: {
                        'click': function (e) {
                            longTermList = longTermList.filter(data => data.no !== e.data.record.no)
                            longTermTable.removeRow(e.data.id)
                            longTermTable.getAll(true).forEach((data, index) => {
                                let newData = {
                                    no: index + 1,
                                    name: data.name
                                }
                                longTermList[index] = newData
                                longTermTable.updateRow(
                                    data.no,
                                    newData
                                )

                            })
                        }
                    }
                }
            ]
        })

        const shortTermTable = $(`#shortTermTable`).grid({
            dataSource: [],
            notFoundText: 'Please add new Short-Term person.',
            primaryKey: 'no',
            orderNumberField: 'no',
            columns: [
                {
                    field: 'no',
                    title: 'No.',
                    width: 62
                },
                {
                    field: 'name',
                    title: 'Name',
                    editor: false
                },
                {
                    field: 'date',
                    title: 'Date',
                    width: 110,
                    align: 'center'
                },
                {
                    field: '',
                    width: 56,
                    type: 'icon',
                    icon: 'fa-solid fa-trash',
                    events: {
                        'click': function (e) {
                            shortTermList = shortTermList.filter(data => data.no !== e.data.record.no)
                            shortTermTable.removeRow(e.data.id)
                            shortTermTable.getAll(true).forEach((data, index) => {

                                let newData = {
                                    no: index + 1,
                                    name: data.name,
                                    date: data.date
                                }
                                longTermList[index] = newData
                                shortTermTable.updateRow(
                                    data.no,
                                    newData
                                )

                            })
                        }
                    }
                }
            ]
        })

        getSaveData()

        pubStartDatePicker.subscribe(tempusDominus.Namespace.events.change, (e) => {
            pubStartDate = e.date

            shortTermTable.clear(true)

            if (e.date != null) {

                minDateForStart = new Date(
                    e.date.getFullYear(),
                    e.date.getMonth(),
                    e.date.getDate(),
                    0,
                    0,
                    0,
                    0
                )
                minDateForEnd = minDateForStart

                pubEndDatePicker.updateOptions({
                    restrictions: {
                        minDate: minDateForEnd
                    }
                })

                startDatePicker.updateOptions({
                    restrictions: {
                        minDate: minDateForStart
                    }
                })
                endDatePicker.updateOptions({
                    restrictions: {
                        minDate: minDateForStart
                    }
                })
            }

            if (pubEndDate == null) {
                btnShortTerm.attr(`disabled`, true)
            } else {
                btnShortTerm.removeAttr(`disabled`)
            }

            checkInput()
        })

        pubEndDatePicker.subscribe(tempusDominus.Namespace.events.change, (e) => {
            pubEndDate = e.date

            shortTermTable.clear(true)

            if (e.date != null) {

                maxDateForStart = new Date(
                    e.date.getFullYear(),
                    e.date.getMonth(),
                    e.date.getDate(),
                    23,
                    59,
                    59,
                    59
                )
                maxDateForEnd = maxDateForStart

                pubStartDatePicker.updateOptions({
                    restrictions: {
                        maxDate: maxDateForStart
                    }
                })

                startDatePicker.updateOptions({
                    restrictions: {
                        maxDate: maxDateForStart
                    }
                })
                endDatePicker.updateOptions({
                    restrictions: {
                        maxDate: maxDateForStart
                    }
                })
            }

            if (pubStartDate == null) {
                btnShortTerm.attr(`disabled`, true)
            } else {
                btnShortTerm.removeAttr(`disabled`)
            }

            checkInput()
        })

        startDatePicker.subscribe(tempusDominus.Namespace.events.change, (e) => {

            if (e.date !== undefined) {
                endDatePicker.updateOptions({
                    restrictions: {
                        minDate: e.date
                    }
                })
            } else {
                endDatePicker.updateOptions({
                    restrictions: {
                        minDate: minDateForEnd
                    }
                })
            }
            if (edtShortTermName.val().length === 0 || e.date == null || endDatePicker.viewDate == null) {
                btnSaveShortTerm.attr(`disabled`, true)
            } else {
                btnSaveShortTerm.removeAttr(`disabled`)
            }
            checkInput()
        })

        endDatePicker.subscribe(tempusDominus.Namespace.events.change, (e) => {

            if (e.date !== undefined) {
                startDatePicker.updateOptions({
                    restrictions: {
                        maxDate: e.date
                    }
                })
            } else {
                startDatePicker.updateOptions({
                    restrictions: {
                        maxDate: maxDateForStart
                    }
                })
            }
            if (edtShortTermName.val().length === 0 || e.date == null || startDatePicker.viewDate == null) {
                btnSaveShortTerm.attr(`disabled`, true)
            } else {
                btnSaveShortTerm.removeAttr(`disabled`)
            }
            checkInput()
        })

        edtLongTermName.on(`input`, function (e) {
            if ($(this).val().length === 0) {
                btnSaveLongTerm.attr(`disabled`, true)
            } else {
                btnSaveLongTerm.removeAttr(`disabled`)
            }
            checkInput()
        })
        edtShortTermName.on(`input`, function (e) {
            if ($(this).val().length === 0 || startDatePicker.viewDate == null || endDatePicker.viewDate == null) {
                btnSaveShortTerm.attr(`disabled`, true)
            } else {
                btnSaveShortTerm.removeAttr(`disabled`)
            }
            checkInput()
        })
        postalCodeInput.on(`input`, function () {
            postalCode = postalCodeInput.val()
            checkInput()
        })
        unitNumberInput.on(`input`, function () {
            unitNumber = unitNumberInput.val()
            checkInput()
        })
        pubGenerateTemplateTitleInput.on(`input`, function () {
            pubGenerateTemplateTitle = pubGenerateTemplateTitleInput.val()
            checkInput()
        })
        pubFeeInput.on(`input`, function () {
            if ($.isNumeric(pubFeeInput.val())) {
                try {
                    pubTotalAmount = parseFloat($(`#pubFee`).val())
                } catch (e) {
                    pubTotalAmount = null
                }
            } else {
                pubTotalAmount = null
            }
            checkInput()
        })
        internetFeeInput.on(`input`, function () {
            if ($.isNumeric(internetFeeInput.val())) {
                try {
                    internetAmount = parseFloat($(`#internetFee`).val())
                } catch (e) {
                    internetAmount = null
                }
            } else {
                internetAmount = null
            }
            checkInput()
        })

        btnSaveLongTerm.on(`click`, function () {
            if (edtLongTermName.val().length === 0) return
            let data = {
                'no': longTermList.length + 1,
                'name': edtLongTermName.val()
            }
            longTermTable.addRow(data)
            longTermList.push(data)
            longTermDialog.hide()
            checkInput()
        })
        btnSaveShortTerm.on(`click`, function () {
            let data = {
                'no': shortTermList.length + 1,
                'name': edtShortTermName.val(),
                'date': startDatePicker.viewDate.toLocaleString('default', {
                    day: `2-digit`,
                    month: '2-digit',
                    year: 'numeric'
                }).replaceAll(`/`, `-`) + '\n' + endDatePicker.viewDate.toLocaleString('default', {
                    day: `2-digit`,
                    month: '2-digit',
                    year: 'numeric'
                }).replaceAll(`/`, `-`)
            }
            shortTermTable.addRow(data)
            shortTermList.push(data)
            shortTermDialog.hide()
        })

        App.MainButton.text = "Submit"
        App.MainButton.onClick(() => {
            if (pubTotalAmount <= 0) {
                App.showPopup(
                    "Error",
                    "PUB Amount can't not be less than equal 0.",
                    [
                        {
                            id: 'okay',
                            type: 'default',
                            text: 'Okay'
                        }
                    ]
                )
                return
            }

            let data = {
                generate_title: pubGenerateTemplateTitle,
                pub_start_date: pubStartDate.toLocaleString('default', {
                    day: `2-digit`,
                    month: '2-digit',
                    year: 'numeric'
                }).replaceAll(`/`, `-`),
                pub_end_date: pubEndDate.toLocaleString('default', {
                    day: `2-digit`,
                    month: '2-digit',
                    year: 'numeric'
                }).replaceAll(`/`, `-`),
                pub_amount: pubTotalAmount,
                internet_amount: internetAmount,
                postal_code: postalCode,
                unit_number: unitNumber,
                long_term_list: longTermList,
                short_term_list: shortTermList,
                save_data: $(`#saveForNextTime`).is(':checked')
            }

            if (shortTermList.length === 0) {
                App.showPopup(
                    "Warning",
                    "Are you sure to Submit without adding Short-Term?",
                    [
                        {
                            id: 'okay',
                            type: 'destructive',
                            text: 'Okay'
                        },
                        {
                            id: 'cancel',
                            type: 'default',
                            text: 'Cancel'
                        }
                    ],
                    function (button_id) {
                        if (button_id === "okay") {
                            if (App.userId != null) {
                                ApiService.submitData(
                                    {
                                        "user_id": App.userId,
                                        "data": data
                                    },
                                    function (response) {
                                        console.log(response)
                                        App.close()
                                    }
                                )
                            }
                        }
                    }
                )
            } else if (App.userId != null) {
                ApiService.submitData(
                    {
                        "user_id": App.userId,
                        "data": data
                    },
                    function (response) {
                        App.disableClosingConfirmation()
                        App.showPopup(
                            "Success",
                            response,
                            [
                                {
                                    id: 'okay',
                                    type: 'default',
                                    text: 'Okay'
                                }
                            ],
                            function (button_id) {
                                if (button_id === `okay`) App.close()
                            }
                        )
                    }
                )
            }
        })

        App.BackButton.onClick(() => {
        })

        function checkInput() {
            if (longTermList.length > 1 && pubGenerateTemplateTitle != null && pubGenerateTemplateTitle !== `` && postalCode !== `` && postalCode != null && unitNumber !== `` && unitNumber != null && pubTotalAmount != null && !isNaN(pubTotalAmount) && internetAmount != null && !isNaN(internetAmount)) {
                App.enableClosingConfirmation()
                App.MainButton.show()
            } else {
                App.disableClosingConfirmation()
                App.MainButton.hide()
            }
        }

        function getSaveData() {
            ApiService.getSaveData(
                {
                    "user_id": App.userId
                },
                function (response) {
                    pubGenerateTemplateTitle = response.generate_title
                    postalCode = response.postal_code
                    unitNumber = response.unit_number
                    if (pubGenerateTemplateTitle) {
                        $(`#labelSaveForNextTime`).addClass(`is-checked`)
                        $(`#saveForNextTime`).attr(`checked`, true)
                        $(`#divGenerateTemplateTitle`).addClass(`is-dirty`)
                        pubGenerateTemplateTitleInput.val(pubGenerateTemplateTitle)
                    }
                    if (postalCode) {
                        $(`#divPostalCode`).addClass(`is-dirty`)
                        postalCodeInput.val(postalCode)
                    }
                    if (unitNumber) {
                        $(`#divUnitNumber`).addClass(`is-dirty`)
                        unitNumberInput.val(unitNumber)
                    }
                    if (response.long_term_list) {
                        response.long_term_list.forEach(data => {
                            longTermTable.addRow(data)
                            longTermList.push(data)
                        })
                    }
                    checkInput()
                }
            )
        }
    })
</script>

</body>
</html>
